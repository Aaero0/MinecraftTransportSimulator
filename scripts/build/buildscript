#!/bin/bash
#Add or change Forge verions and mappings here
FORGEVERSION[70]="1.7.10-10.13.4.1558-1.7.10"
FORGEVERSION[80]="1.8-11.14.3.1502"
FORGEVERSION[89]="1.8.9-11.15.1.1722"
FORGEVERSION[90]="1.9-12.16.0.1865-1.9"
FORGEVERSION[94]="1.9.4-12.17.0.1957"
FORGEVERSION[102]="1.10.2-12.18.1.2011"
#Used only with newer forge versions
FORGEMAPPING[80]="stable_18"
FORGEMAPPING[89]="stable_22"
FORGEMAPPING[90]="stable_24"
FORGEMAPPING[94]="stable_26"
FORGEMAPPING[102]="snapshot_20160823"

#Change mod parameters here
MAINPATH="/home/$USER/.minecraft/forge/moddingEnvironments/"
PREFIX="MFS"
MODNAME="Minecraft Flight Simulator"
MODMAINFILE="src/main/java/minecraftflightsimulator/MFS.java"
#PREFIX="RFPR"
#MODNAME="Real First-Person Render"
#MODMAINFILE="src/main/java/realrender/REN.java"
HEADEROLD="./gradle-header-old"
HEADERNEW="./gradle-header-new"
FOOTER="./gradle-footer"

echo "Searching current directory for folders with names $PREFIX*"
DIRLIST=($(find $MAINPATH -maxdepth 1 -type d -name "$PREFIX*"))
NUMDIRS=${#DIRLIST[*]}
if [ $NUMDIRS -eq 0 ]; then
	echo "No compatible directories found."
	echo "Ensure the directories follow the naming format of $PREFIX###."
	exit
fi

COUNT=0
echo "Found the following versions:"
printf "%-2s  %-10s %-10s\n" "##" "VERSION" "DIRECTORY"
for FOLDER in ${DIRLIST[*]}; do
	VER=${FOLDER:$(expr index "$FOLDER" "$PREFIX") + 2}
	if [ -z $VER ]; then
		VERSIONS[$COUNT]=000
	else
		VERSIONS[$COUNT]=$VER
	fi
	printf "%2d  %-10s %-10s\n" "$(($COUNT + 1))" "${VERSIONS[$COUNT]}"  "$FOLDER"
	let COUNT=COUNT+1;
done

echo "Enter the number of the version to compile"
echo "or press ENTER for all versions."
echo -n ":"
read COMPVER
if ! [ $COMPVER -eq $COMPVER ] 2> /dev/null
then
	echo "$COMPVER isn't a number! ABORTING!"
	exit
fi

COUNT=0
while [ $COUNT -lt $NUMDIRS ]; do
	VER=${VERSIONS[$COUNT]}
	if ! [ -z $COMPVER ]; then
		if ! [ $VER -eq $COMPVER ]; then
			let COUNT=$COUNT+1
			continue
		fi
	fi
	BUILDFILE=${DIRLIST[$COUNT]}/build.gradle
	MODVERLINE=$(cat ${DIRLIST[$COUNT]}/$MODMAINFILE | grep MODVER=);
	MODVERSTART=$(expr index "$MODVERLINE" "=")
	MODVEREND=$(expr index "$MODVERLINE" ";")
	MCVER=$(expr substr ${FORGEVERSION[$VER]} 1 $(($(expr index ${FORGEVERSION[$VER]} "-") - 1)))
	MODVER=${MODVERLINE:$(($MODVERSTART + 1)):$(($MODVEREND-$MODVERSTART-3))}

	echo "Compiling version: $MCVER-$MODVER"
	if [ $VER -le 80 ]; then
		cat $HEADEROLD > $BUILDFILE
		echo "minecraft{" >> $BUILDFILE
		echo "		version = \"${FORGEVERSION[$VER]}\"" >> $BUILDFILE
		echo "		runDir = \"eclipse\"" >> $BUILDFILE
		if [ $VER -eq 80 ]; then echo "		mappings = \"${FORGEMAPPING[$VER]}\"" >> $BUILDFILE; fi
		echo "}" >> $BUILDFILE
		echo "" >> $BUILDFILE
		echo "version = \"$MCVER-$MODVER\"" >> $BUILDFILE
		echo "group = \"com.don_bruce.${PREFIX,,}\"" >> $BUILDFILE
		echo "archivesBaseName = \"$MODNAME\"" >> $BUILDFILE
		cat $FOOTER >> $BUILDFILE
	else
                cat $HEADERNEW > $BUILDFILE
                echo "minecraft{" >> $BUILDFILE
                echo "		version = \"${FORGEVERSION[$VER]}\"" >> $BUILDFILE
                echo "		runDir = \"run\"" >> $BUILDFILE
		echo "		mappings = \"${FORGEMAPPING[$VER]}\"" >> $BUILDFILE
		echo "		makeObfSourceJar = false" >> $BUILDFILE
                echo "}" >> $BUILDFILE
                echo "" >> $BUILDFILE
                echo "version = \"$MCVER-$MODVER\"" >> $BUILDFILE
                echo "group = \"com.don_bruce.${PREFIX,,}\"" >> $BUILDFILE
                echo "archivesBaseName = \"$MODNAME\"" >> $BUILDFILE
                cat $FOOTER >> $BUILDFILE
	fi
	cd ${DIRLIST[$COUNT]}
	./gradlew build
	cd ..
	let COUNT=$COUNT+1
done
